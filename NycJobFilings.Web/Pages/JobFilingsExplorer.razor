@page "/job-filings"
@using NycJobFilings.Data.Models
@using NycJobFilings.Data.Services


<h1>NYC DOB Job Filings Explorer</h1>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Filters</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var filter in ActiveFilters)
                    {
                        <div class="filter-chip">
                            <span>@filter.DisplayText</span>
                            <button type="button" class="btn-close" aria-label="Remove filter" @onclick="() => RemoveFilter(filter)"></button>
                        </div>
                    }
                    <div class="filter-chip add-filter" @onclick="AddNewFilter">
                        <span>+ Add Filter</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Job Filings</h5>
                <div class="d-flex gap-2">
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ShowColumnChooser">
                            <span class="oi oi-list" aria-hidden="true"></span> Columns
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="SaveCurrentFilterSet">
                            <span class="oi oi-bookmark" aria-hidden="true"></span> Save Filter
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                @if (IsLoading)
                {
                    <div class="loading-container">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: @ProgressPercentage%" aria-valuenow="@ProgressPercentage" aria-valuemin="0" aria-valuemax="100">
                                @(LoadingState?.LoadedRecords ?? 0) / @(LoadingState?.TotalRecords ?? 0)
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger mt-2" @onclick="CancelLoading">Cancel</button>
                    </div>
                }
                else if (JobFilings == null || !JobFilings.Any())
                {
                    <div class="alert alert-info">No job filings found. Try adjusting your filters.</div>
                }
                else
                {
                    <div class="grid-container">
                        <DxGrid Data="@JobFilings"
                                ShowFilterRow="true"
                                ShowPager="true"
                                PageSize="50"
                                PageSizeSelectorVisible="true"
                                PageSizeItems="@(new[] { 10, 25, 50, 100 })"
                                CssClass="job-filings-grid"
                                ColumnResizeMode="GridColumnResizeMode.ColumnsContainer">
                            <Columns>
                                <DxGridCommandColumn Width="100px" Caption="Actions">
                                </DxGridCommandColumn>
                                @foreach (var column in VisibleColumns)
                                {
                                    <DxGridDataColumn 
                                        Field="@column.FieldName"
                                        Caption="@column.DisplayName" 
                                        Width="@($"{column.Width}px")"
                                        ToolTip="@column.Description"
                                        SortOrder="@(column.FieldName == "JobS1No" ? GridColumnSortOrder.Ascending : GridColumnSortOrder.None)"
                                        SortIndex="@(column.FieldName == "JobS1No" ? 0 : -1)">
                                    </DxGridDataColumn>
                                }
                            </Columns>
                        </DxGrid>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Filing Trends</h5>
            </div>
            <div class="card-body">
                <!-- This would be replaced by a DevExpress chart in a real implementation -->
                <div class="chart-placeholder">
                    <p>Chart would be displayed here showing trends based on the current filters.</p>
                    <p>For example: Job filings by month, borough distribution, or job status breakdown.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal dialogs for filters, column chooser, etc. -->
<DxPopup HeaderText="Column Chooser" 
         @bind-Visible="@IsColumnChooserVisible"
         Width="600px"
         Closing="@((e) => { if (!e.Cancel) IsColumnChooserVisible = false; })">
    <Content>
        <div class="container">
            <div class="row mb-3">
                <div class="col">
                    <p>Select columns to display and drag to reorder:</p>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <DxListBox Data="@AllColumns"
                              TData="ColumnMetadata"
                              TValue="ColumnMetadata"
                              CssClass="column-chooser-list"
                              SelectionMode="ListBoxSelectionMode.Multiple"
                              Values="@SelectedColumns"
                              ValuesChanged="@((IEnumerable<ColumnMetadata> values) => { SelectedColumns = values.ToList(); })">
                        <ItemTemplate>
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <span>@(context.DisplayName)</span>
                                <small class="text-muted">@(context.DataType)</small>
                            </div>
                        </ItemTemplate>
                    </DxListBox>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col d-flex justify-content-end">
                    <DxButton RenderStyle="ButtonRenderStyle.Secondary" 
                              RenderStyleMode="ButtonRenderStyleMode.Outline" 
                              Text="Cancel" 
                              Click="@(() => IsColumnChooserVisible = false)" 
                              CssClass="me-2" />
                    <DxButton RenderStyle="ButtonRenderStyle.Primary" 
                              Text="Apply" 
                              Click="@SaveColumnPreferences" />
                </div>
            </div>
        </div>
    </Content>
</DxPopup>

<!-- Save Filter Dialog -->
<DxPopup HeaderText="Save Filter Set" 
         @bind-Visible="@IsSaveFilterDialogVisible"
         Width="400px"
         Closing="@((e) => { if (!e.Cancel) IsSaveFilterDialogVisible = false; })">
    <Content>
        <div class="container">
            <div class="row mb-3">
                <div class="col">
                    <label for="filterSetName" class="form-label">Filter Set Name</label>
                    <DxTextBox @bind-Text="@FilterSetName" CssClass="form-control" />
                </div>
            </div>
            <div class="row">
                <div class="col d-flex justify-content-end">
                    <DxButton RenderStyle="ButtonRenderStyle.Secondary" 
                              RenderStyleMode="ButtonRenderStyleMode.Outline" 
                              Text="Cancel" 
                              Click="@(() => IsSaveFilterDialogVisible = false)" 
                              CssClass="me-2" />
                    <DxButton RenderStyle="ButtonRenderStyle.Primary" 
                              Text="Save" 
                              Click="@SaveFilterSetToStorage" />
                </div>
            </div>
        </div>
    </Content>
</DxPopup>